---
title: "LC50 Nickel Experiment 1"
author: "Celeste Valdivia"
date: "2024-04-10"
output: html_document
---

```{r, eval =TRUE}
library(knitr)
library(tidyverse)
library(tidyr)
library(dplyr)
library(hrbrthemes)
library(ggplot2)
library(RColorBrewer)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE,
                      eval = FALSE)
```

# Retrieving Data from Google Sheets


Make sure you have made your Google sheet publicly available to anyone that has the link. If you make any updates to the sheet just re-curl the data, meaning just re-run the code below.

```{r, engine='bash', eval=FALSE}
cd ..

curl -L https://docs.google.com/spreadsheets/d/1JtJO3EX06BYK4pYwZZ7b7ZCoTyZcAeuTRka_9kA-yPk/export?exportFormat=csv | tee data/LC50.csv
```

Read in the data to your local R environment.

```{r, eval=TRUE}
setwd('..')
LC50 <- read.csv(file = "data/LC50.csv")  
```

# Cleaning up Data

```{r, eval=TRUE}
LC50$Date <- mdy(LC50$Date) #convert the Date column from characters to true Date

LC50_fact <- LC50 %>%
  mutate(Ni.Conc. = as.factor(Ni.Conc.)) %>%
  mutate(Tunicate.ID = as.factor(Tunicate.ID)) %>%
  na.omit

# Create a new column 'simple_Stage' based on conditions
LC50_fact <- LC50_fact %>%
  mutate(simple_Stage = case_when(
    Stage %in% c("A1", "A2") ~ "A",
    Stage %in% c("B1", "B2") ~ "B",
    Stage %in% c("C1", "C2") ~ "C",
    Stage == "D" ~ "D",
    TRUE ~ NA_character_  # This will handle any other cases or return NA if none match
  ))

# Create new simplified health scoring
LC50_fact <- LC50_fact %>%
  mutate(simple_health = case_when(
    Health == "0" ~ "0",
    Health %in% c("1", "2") ~ "1",
    Health %in% c("3", "4") ~ "2",
    Health %in% c("5", "6") ~ "3",
    Health %in% c("7", "8") ~ "4",
    Health %in% c("9", "10") ~ "5",
    TRUE ~ NA_character_)) %>%
  transform(simple_health = as.numeric(simple_health))

summary(LC50_fact)
```

# Summary Stats

```{r}
avg_zooid <- mean(LC50_fact$Total.Zooids, na.rm = TRUE)
sd_zooid <- sd(LC50_fact$Total.Zooids, na.rm = TRUE)
print(c(avg_zooid, sd_zooid))
```


# Calculate Percent Mortality per Treatment

```{r}
calc_mort_perecnt <- function(data) {
  
  total_individuals <- aggregate(Mortality ~ hpe + Ni.Conc., data = data, FUN = length)
  
  total_mortality <- aggregate(Mortality ~ hpe + Ni.Conc., data = data, FUN = sum)
  
  merged_data <- merge(total_individuals, total_mortality, by = c( "hpe",  "Ni.Conc."), suffixes = c(".total", ".count"))
  
  merged_data$percentage_mortality <- (merged_data$Mortality.count / merged_data$Mortality.total) *100
  
  return(merged_data)
}

mortality_percentage <- calc_mort_perecnt(LC50_fact)

mortality_percentage$hpe <- as.character(mortality_percentage$hpe) # Did this so I can have discrete colors for plot for the time points instead of a gradient

print(mortality_percentage)
summary(mortality_percentage)

test <- transform(mortality_percentage,
                             Ni.Conc. = as.numeric(Ni.Conc.))

mortality_percentage$Ni.Conc. <- as.numeric(mortality_percentage$Ni.Conc.) # Did this so geom_smooth actually works

```



# Exploratory percent mort graph

```{r}
ggplot(mortality_percentage, aes(x=Ni.Conc., y=percentage_mortality, color = hpe)) + 
  geom_point() +
  facet_wrap(~ hpe) +
  geom_smooth(aes(fill = hpe), method = "loess", span = 1) +
      labs(x = "Nickel mg/L",
       y = "Mortality (%)")  +
scale_x_continuous(breaks = c(0, 24, 48, 72, 96)) +
  ylim(0, 5) +
  geom_smooth(aes(fill = Ni.Conc.), method = "lm", se = TRUE) +  # Add linear regression line with shaded SE
  labs(x = "hpe", 
       y = "Health"
       )
```

# Dose Response Models Readings

We do not have a traditional sigmoidal dose response curve as an option. Botryllus remain with heartbeat up to 100 mg/L and cease blood movement at 1000 mg/L after 48 hours.

https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0146021

https://www.linkedin.com/pulse/simple-lc50-calculation-pesticide-toxicity-bioassay-using-adhiwibawa

Eventually will need to explore packages for assessing LC50 or EC50.

# Exploratory Blastogenic Arrest

https://www.sciencedirect.com/science/article/pii/S0012160618303828

above they refer to arrest and they interchangibly refer to torpor in 

We may define effect concentration 50% by blastogenic arrest or blastogenic development inhibition in the animal as a chronic endpoint of nickel toxicity. 

a. Need to account for rate of blastogenesis again. One step per day is normal and should be found in the control animal.

b. In the 100 treatment for more than 3 days we see no change in blastogenic rate. The line will be flat over time.

Exploratory health
```{r}
ggplot(LC50_fact, aes(x = hpe, y = simple_health, color = Ni.Conc.)) + 
  geom_point() +
  facet_wrap(~ Ni.Conc., labeller = as_labeller(c("0" = "0 mg/L", "0.1" = "0.1 mg/L", "1" = "1 mg/L", "10" = "10 mg/L", "100" = "100 mg/L", "1000" = "1000 mg/L"))) +
  scale_x_continuous(breaks = c(0, 24, 48, 72, 96)) +
  ylim(0, 5) +
  geom_smooth(aes(fill = Ni.Conc.), method = "lm", se = TRUE) +  # Add linear regression line with shaded SE
  labs(x = "hpe", 
       y = "Health"
       )

```



```{r}
y_breaks <- 1:7
y_labels <- c("A1", "A2", "B1", "B2", "C1", "C2", "D")

stage_mapping <- c(A1 = 1, A2 = 2, B1 = 3, B2 = 4, C1 = 5, C2 = 6, D = 7)

LC50_fact$Stage_Num <- stage_mapping[LC50_fact$Stage]
```



```{r}
ggplot(LC50_fact, aes(x = hpe, y = Stage_Num)) + 
  geom_point(alpha = 0.6, size = 2) +  # Adjust transparency and size of points
  geom_line(aes(group = Tunicate.ID)) +  # Connect points with lines for each Tunicate.ID
  scale_y_continuous(breaks = y_breaks, labels = y_labels) +  # Custom breaks and labels for y-axis
  scale_x_continuous(breaks = c(0, 24, 48, 72, 96)) +  # Custom breaks for x-axis
  labs(x = "hpe", y = "stage") +  # Axis labels
  facet_wrap(~ Ni.Conc., labeller = as_labeller(c("0" = "0 mg/L", "0.1" = "0.1 mg/L", "1" = "1 mg/L", "10" = "10 mg/L", "100" = "100 mg/L", "1000" = "1000 mg/L")))
```


# Test Data

```{r}
df <- LC50_fact[LC50_fact$Tunicate.ID == "DM012024_C01", ]

stage_mapping <- c(A1 = 1, A2 = 2, B1 = 3, B2 = 4, C1 = 5, C2 = 6, D = 7)

df$Stage_Num <- stage_mapping[df$Stage]

summary(df)
```

```{r}
y_breaks <- 1:7
y_labels <- c("A1", "A2", "B1", "B2", "C1", "C2", "D")

ggplot(df, aes(x = hpe, y = Stage_Num, color = Ni.Conc.)) + 
  geom_point(alpha = 0.6, size = 3) +  # Adjust transparency and size of points
  geom_smooth(method = "loess", se = FALSE, span = 0.9)  +
  scale_y_continuous(breaks = y_breaks, labels = y_labels) +  # Custom breaks and labels for y-axis
    scale_x_continuous(breaks = c(0, 24, 48, 72, 96)) +
  labs(x = "hpe", y = "stage")

```